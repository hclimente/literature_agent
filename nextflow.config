params {
    research_interests = "${projectDir}/config/research_interests.md"
    journal_list       = "${projectDir}/config/journals.tsv"
    database_path      = "literature_agent.duckdb"
    outdir             = "results"
    metadata_extraction {
        model = "gemini-2.5-flash-lite"
        system_prompt = "${projectDir}/prompts/metadata_extraction.md"
    }
    screening {
        model = "gemini-2.5-flash-lite"
        system_prompt = "${projectDir}/prompts/screening.md"
    }
    prioritization {
        model = "gemini-2.5-flash-lite"
        system_prompt = "${projectDir}/prompts/prioritization.md"
    }
}

plugins {
    id 'nf-sqldb'
}

sql {
    db {
        articles_db {
            url = "jdbc:duckdb:${params.database_path}"
        }
    }
}

docker {
    enabled = true
    runOptions = "--platform linux/amd64"
}

process {
    maxForks = 10
    errorStrategy = 'terminate'  // Fail fast as you want
    maxRetries = 0

    withLabel: 'gemini_api' {
        maxForks = 3
        submitRateLimit = '10/1min'
        errorStrategy = {
            if (task.exitStatus == 429) { // Rate limit error
                task.attempt <= 10 ? 'retry' : 'terminate'
            } else {
                'retry'
            }
        }
        maxRetries = 10
        // Exponential backoff: 2^attempt seconds
        beforeScript = 'sleep $((2**($NXF_TASK_ATTEMPT-1)))'
    }
}

executor {
    $local {
        queueSize = 50
        submitRateLimit = '60/1min'
        pollInterval = '2sec'
    }
}
